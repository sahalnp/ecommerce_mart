<%- include('../partials/header') %>

<main class="main-wrap">
  <div class="container mt-4">
    <% if (viewOrder && viewOrder.items && viewOrder.items.length > 0) { %>
      <% viewOrder.items.forEach(item => { %>
        <div class="card mb-4">
          <form action="/admin/orders/editOrder/<%= viewOrder._id %>" method="POST">
            <input type="hidden" name="redirectTo" value="<%= redirectTo || '/admin/orders' %>">

            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            
            <input type="hidden" name="productId" value="<%= item.product._id %>">

            <div class="card-header bg-primary text-white">
              <h5>Order ID: <%= viewOrder.OrderId %></h5>
            </div>
            <div class="card-body">
              <!-- Customer Info -->
              <div class="row mb-4">
                <div class="col-12 mb-3">
                  <h6 class="mb-2">Customer Email</h6>
                  <p class="mb-0"><%= viewOrder.UserId?.email %></p>
                </div>
                <div class="col-12">
                  <h6 class="mb-2">Address</h6>
                  <div class="address-info">
                    <p class="mb-1"><strong><%= address.name %></strong></p>
                    <p class="mb-1"><%= address.number %></p>
                    <p class="mb-1"><%= address.street %>, <%= viewOrder.billingAddress?.localPlace %></p>
                    <p class="mb-1">Landmark: <%= address.landmark %></p>
                    <p class="mb-1"><%= address.city %>, <%= viewOrder.billingAddress?.district %> – <%= address.pincode %></p>
                    <p class="mb-1"><%= address.state %>, <%= viewOrder.billingAddress?.country %></p>
                    <p class="mb-0">Type: <%= address.addressType %></p>
                  </div>
                </div>
              </div>

              <!-- Product Info -->
              <div class="row mb-3">
                <div class="col-12">
                  <h6 class="mb-2">Product</h6>
                  <p class="mb-3"><strong><%= item.product?.title %></strong></p>
                  <div class="mb-3">
                    <% if (item.product?.image?.length > 0) { %>
                      <img src="<%= item.product.image[0].filepath %>" class="img-thumbnail" style="max-height: 150px; max-width: 150px; object-fit: cover;">
                    <% } else { %>
                      <div class="text-muted"><p>No product image</p></div>
                    <% } %>
                  </div>
                </div>
              </div>

              <!-- Product Details -->
              <div class="row mb-3">
                <div class="col-md-3 col-6 mb-2"><strong>Qty:</strong> <%= item.quantity %></div>
                <div class="col-md-3 col-6 mb-2"><strong>Price:</strong> ₹<%= item.price?.toLocaleString() %></div>
                <div class="col-md-3 col-6 mb-2"><strong>Processing Fee:</strong> ₹<%= item.processingFee || 0 %></div>
                <% if (viewOrder.discount) { %>
                  <div class="col-md-3 col-6 mb-2"><strong>Discount:</strong> ₹<%= viewOrder.discount %></div>
                <% } %>
              </div>

              <!-- Total -->
              <div class="row mb-3">
                <div class="col-12">
                  <div class="bg-light p-3 rounded">
                    <h6 class="mb-0"><strong>Total Amount: ₹<%= viewOrder.total?.toLocaleString() %></strong></h6>
                  </div>
                </div>
              </div>

              <!-- Payment and Order Info -->
              <div class="row mb-3">
                <div class="col-md-6 mb-2"><strong>Payment Method:</strong> <%= viewOrder.paymentMethod %></div>
                <div class="col-md-6 mb-2"><strong>Order Date:</strong> <%= new Date(viewOrder.OrderDate).toLocaleDateString('en-IN') %></div>
              </div>

              <!-- ✅ Combined Order + Payment Status -->
              <div class="row">
                <div class="col-12">
                  <div class="border-top pt-3">
                    <!-- Order Status -->
                    <h6 class="mb-3">Order Status</h6>
                    <% if (viewOrder.status === 'Return requested' || viewOrder.status === 'Refunded') { %>
                      <div class="alert alert-danger"><strong>Status:</strong> <%= viewOrder.status %></div>
                      <% if (viewOrder.status === 'Return requested') { %>
                        <input type="hidden" name="status" value="Refunded">
                      <% } %>
                    <% } else { %>
                      <label for="status" class="form-label">Update Status:</label>
                      <select name="status" id="status" class="form-select mb-3">
                        <option value="<%= viewOrder.status %>" selected><%= viewOrder.status %></option>
                        <% if (viewOrder.status !== 'Delivered' && viewOrder.status !== 'Cancelled') { %>
                          <% if (viewOrder.status !== 'Pending') { %><option value="Pending">Pending</option><% } %>
                          <% if (viewOrder.status !== 'Shipped') { %><option value="Shipped">Shipped</option><% } %>
                          <% if (viewOrder.status !== 'Refunded') { %><option value="Refunded">Refunded</option><% } %>
                          <option value="Delivered">Delivered</option>
                          <option value="Cancelled">Cancelled</option>
                        <% } %>
                      </select>
                    <% } %>

                    <!-- Payment Status -->
                    <h6 class="mt-4 mb-3">Payment Status</h6>
                    <label for="paymentStatus" class="form-label">Update Payment:</label>
                    <select name="paymentStatus" id="paymentStatus" class="form-select mb-4">
                      <option value="<%= viewOrder.paymentStatus %>" selected><%= viewOrder.paymentStatus %></option>
                      <% if (viewOrder.paymentStatus !== 'Pending') { %><option value="Pending">Pending</option><% } %>
                      <% if (viewOrder.paymentStatus !== 'Completed') { %><option value="Completed">Completed</option><% } %>
                      <% if (viewOrder.paymentStatus !== 'Refunded') { %><option value="Refunded">Refunded</option><% } %>
                    </select>

                    <!-- Single Submit Button -->
                    <button type="submit" class="btn btn-primary w-100">
                      <i class="fas fa-save me-2"></i>&nbsp;Update Order
                    </button>
                  </div>
                </div>
              </div>
              <!-- ✅ End Combined Section -->
            </div>
          </form>
        </div>
      <% }) %>
    <% } else { %>
      <div class="alert alert-warning text-center">
        <h5>No order data found</h5>
      </div>
    <% } %>
  </div>
</main>

<%- include('../partials/footer') %>
