<%- include('../partials/header') %>
<head>
    <style>
        .category-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }
        .category-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .category-item input[type="checkbox"] {
            vertical-align: middle;
            margin-top: 7px;
        }
        .small-button {
            width: auto;
            padding: 6px 12px;
            font-size: 13px;
            background: #0056b3;
            margin-bottom: 15px;
            display: inline-block;
            color: white;
            border: none;
            border-radius: 4px;
        }
        #image-wrapper input[type="file"] {
            display: block;
            margin-bottom: 10px;
        }
        .image-container {
            transition: opacity 0.3s ease;
        }
        .image-container.removing {
            opacity: 0;
        }
    </style>
</head>

<%- include('../partials/navbar') %>

<div class="app-content content">
    <div class="content-wrapper" style="margin-top: 50px">
        <div class="content-header row">
            <div class="content-header-left col-md-6 col-12 mb-2">
                <h3 class="content-header-title text-dark">Edit Product</h3>
            </div>
        </div>
        <div class="content-body">
            <section id="edit-product">
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="card shadow-sm rounded">
                            <div class="card-header bg-primary">
                                <h4 class="card-title mb-0 text-white">
                                    Product Details
                                </h4>
                            </div>
                            
                            <div class="card-body">
                                <form
                                    method="POST"
                                    action="/admin/product/edit/<%= product._id %>"
                                    enctype="multipart/form-data"
                                >
                                 <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            
                                    <input
                                        type="hidden"
                                        name="id"
                                        value="<%= product._id %>"
                                    />

                                    <!-- Basic Info -->
                                    <div class="form-group">
                                        <label for="title">Product Title</label>
                                        <input
                                            type="text"
                                            id="title"
                                            name="title"
                                            class="form-control"
                                            value="<%= product.title %>"
                                            required
                                        />
                                    </div>

                                    <!-- Brand Section -->
                                    <label for="brand">Brand</label>
                                    <div class="category-group">
                                        <% brand.forEach((b, index) => { %>
                                        <div class="category-item">
                                            <input type="radio" id="brand<%=
                                            index %>" name="brandradio"
                                            value="<%= b._id %>" <%=
                                            product.brand &&
                                            product.brand._id.toString() ===
                                            b._id.toString() ? 'checked' : '' %>
                                            />
                                            <label for="brand<%= index %>"
                                                ><%= b.name %></label
                                            >
                                        </div>
                                        <% }); %>
                                    </div>

                                    <!-- Description -->
                                    <div class="form-group">
                                        <label for="description"
                                            >Description</label
                                        >
                                        <textarea
                                            id="description"
                                            name="description"
                                            class="form-control"
                                            rows="4"
                                        ><%= product.description %></textarea>
                                    </div>

                                    <!-- Pricing -->
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="productPrice"
                                                >Product Price</label
                                            >
                                            <input
                                                type="number"
                                                id="productPrice"
                                                name="productPrice"
                                                class="form-control"
                                                value="<%= product.pricing?.price %>"
                                                required
                                            />
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="salePrice"
                                                >Sale Price</label
                                            >
                                            <input
                                                type="number"
                                                id="salePrice"
                                                name="salePrice"
                                                class="form-control"
                                                value="<%= product.pricing?.salePrice %>"
                                                required
                                            />
                                        </div>
                                    </div>

                                    <!-- Product Specifications -->
                                    <h3 class="mt-4">Product Specifications</h3>
                                    <div class="form-group">
                                        <label for="bandColour"
                                            >Band Colour</label
                                        ><input
                                            type="text"
                                            id="bandColour"
                                            name="bandColour"
                                            class="form-control"
                                            value="<%= product.bandColour %>"
                                            required
                                        />
                                    </div>
                                    <div class="form-group">
                                        <label for="bandMaterial"
                                            >Band Material Type</label
                                        ><input
                                            type="text"
                                            id="bandMaterial"
                                            name="bandMaterial"
                                            class="form-control"
                                            value="<%= product.bandMaterial %>"
                                            required
                                        />
                                    </div>
                                    <div class="form-group">
                                        <label for="warranty"
                                            >Warranty (months)</label
                                        ><input
                                            type="number"
                                            id="warranty"
                                            name="warranty"
                                            class="form-control"
                                            value="<%= product.warranty %>"
                                            required
                                        />
                                    </div>
                                    <div class="form-group">
                                        <label for="movementType"
                                            >Watch Movement Type</label
                                        ><input
                                            type="text"
                                            id="movementType"
                                            name="movementType"
                                            class="form-control"
                                            value="<%= product.movementType %>"
                                            required
                                        />
                                    </div>
                                    <div class="form-group">
                                        <label for="itemWeight"
                                            >Item Weight</label
                                        ><input
                                            type="text"
                                            id="itemWeight"
                                            name="itemWeight"
                                            class="form-control"
                                            value="<%= product.itemWeight %>"
                                            required
                                        />
                                    </div>
                                    <div class="form-group">
                                        <label for="modelNumber"
                                            >Model Number</label
                                        ><input
                                            type="text"
                                            id="modelNumber"
                                            name="modelNumber"
                                            class="form-control"
                                            value="<%= product.modelNumber %>"
                                            required
                                        />
                                    </div>
                                    <div class="form-group">
                                        <label for="caseShape">Case Shape</label
                                        ><input
                                            type="text"
                                            id="caseShape"
                                            name="caseShape"
                                            class="form-control"
                                            value="<%= product.caseShape %>"
                                            required
                                        />
                                    </div>
                                    <div class="form-group">
                                        <label for="specialFeatures"
                                            >Special Features</label
                                        ><input
                                            type="text"
                                            id="specialFeatures"
                                            name="specialFeatures"
                                            class="form-control"
                                            value="<%= product.specialFeatures %>"
                                            required
                                        />
                                    </div>

                                    <div class="form-group">
                                        <label for="caseDiameter"
                                            >Case Diameter</label
                                        ><input
                                            type="text"
                                            id="caseDiameter"
                                            name="caseDiameter"
                                            class="form-control"
                                            value="<%= product.caseDiameter %>"
                                            required
                                        />
                                    </div>

                                    <!-- Images Section -->
                                    <div class="form-group">
                                        <label>Product Images</label>
                                        <div id="image-wrapper">
                                            <input
                                                type="file"
                                                name="images"
                                                accept="image/*"
                                                class="form-control-file"
                                            />
                                        </div>
                                        <button
                                            type="button"
                                            id="add-image-btn"
                                            class="small-button"
                                        >
                                            + Add Image
                                        </button>

                                        <div class="form-group">
                                            <label for="imagePosition"
                                                >Enter Position for New
                                                Image:</label
                                            >
                                            <input
                                                style="width: 300px"
                                                type="number"
                                                id="imagePosition"
                                                class="form-control"
                                                placeholder="Enter a position number"
                                                min="1"
                                            />
                                        </div>

                                        <div class="row" id="existing-images-container">
                                            <% product.image.forEach(function(img, index) { %>
                                            <div
                                                class="col-md-4 text-center mb-3 position-relative image-container"
                                                data-image-id="<%= img._id || img %>"
                                                data-image-type="regular"
                                            >
                                                <label>Image <%= index + 1 %>:</label>
                                                <img
                                                    src="<%= img.filepath %>"
                                                    class="img-fluid rounded shadow-sm"
                                                    style="
                                                        height: 120px;
                                                        object-fit: cover;
                                                    "
                                                    alt="Product Image"
                                                />
                                                <input
                                                    type="hidden"
                                                    name="existingImages[]"
                                                    value="<%= img._id || img %>"
                                                />
                                                <button
                                                    type="button"
                                                    class="btn btn-danger btn-sm delete-image-btn ml-2"
                                                    data-image="<%= img._id || img %>"
                                                    data-product-id="<%= product._id %>"
                                                    data-image-type="regular"
                                                    style="
                                                        position: absolute;
                                                        top: 2px;
                                                        right: 2px;
                                                    "
                                                >
                                                    🗑️
                                                </button>
                                            </div>
                                            <% }); %>
                                        </div>
                                    </div>

                                    <!-- VR Image Section -->
                                    <div class="form-group">
                                        <label>VR Image</label>
                                        <div id="vr-image-wrapper">
                                            <input
                                                type="file"
                                                name="vrImage"
                                                accept="image/*"
                                                class="form-control-file"
                                                style="height: 50px;"
                                            />
                                        </div>
                                        
                                        <% if(product.vrImage) { %>
                                        <div 
                                            class="col-md-4 text-center mb-3 position-relative image-container" 
                                            data-image-id="<%= product.vrImage._id %>"
                                            data-image-type="vr"
                                            id="vr-image-container"
                                        >
                                            <label>Current VR Image:</label>
                                            <img
                                                src="<%= product.vrImage.filepath %>"
                                                class="img-fluid rounded shadow-sm"
                                                style="height: 120px; object-fit: cover;"
                                                alt="VR Image"
                                            />
                                            <input
                                                type="hidden"
                                                name="existingVrImage"
                                                value="<%= product.vrImage._id %>"
                                            />
                                            <button
                                                type="button"
                                                class="btn btn-danger btn-sm delete-image-btn ml-2"
                                                data-image="<%= product.vrImage._id %>"
                                                data-product-id="<%= product._id %>"
                                                data-image-type="vr"
                                                style="position: absolute; top: 2px; right: 2px;"
                                            >
                                                🗑️
                                            </button>
                                        </div>
                                        <% } %>
                                    </div>

                                    <!-- Category Section -->
                                    <div class="form-group">
                                        <label>Category</label>
                                        <div class="category-group">
                                            <% if (categry && categry.length >
                                            0) { %> <% const
                                            selectedCategoryNames =
                                            product.category.map(cat => (typeof
                                            cat === 'object' && cat.name) ?
                                            cat.name : cat.toString() ); %> <%
                                            categry.forEach((category, index) =>
                                            { %>
                                            <div class="category-item">
                                                <input type="checkbox"
                                                id="category<%= index %>"
                                                name="categorybox[]" value="<%=
                                                category.name %>" <%=
                                                selectedCategoryNames.includes(category.name)
                                                ? 'checked' : '' %> />
                                                <label
                                                    style="margin-top: 13px"
                                                    for="category<%= index %>"
                                                    ><%= category.name %></label
                                                >
                                            </div>
                                            <% }); %> <% } %>
                                        </div>
                                    </div>

                                    <!-- Stock & Listing -->
                                    <div class="form-group">
                                        <label for="inStock">In Stock</label>
                                        <input
                                            type="number"
                                            id="inStock"
                                            name="inStock"
                                            class="form-control"
                                            value="<%= product.inStock %>"
                                        />
                                    </div>
                                    <div class="form-group form-check">
                                        <input type="checkbox" name="isListed"
                                        class="form-check-input" id="isListed"
                                        <%= product.isListed ? 'checked' : '' %>
                                        />
                                        <label
                                            class="form-check-label"
                                            for="isListed"
                                            >Status</label
                                        >
                                    </div>

                                    <button
                                        type="submit"
                                        class="btn btn-primary btn-block"
                                    >
                                        Update Product
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
const csrfToken = "<%= csrfToken %>";

// Add image functionality
document.getElementById("add-image-btn")?.addEventListener("click", function () {
    const wrapper = document.getElementById("image-wrapper");
    const positionInput = document.getElementById("imagePosition");
    const position = positionInput.value;

    const input = document.createElement("input");
    input.type = "file";
    input.name = "images";
    input.accept = "image/*";
    input.className = "form-control-file";

    const existingInputs = wrapper.querySelectorAll('input[type="file"]');

    if (position && !isNaN(position) && position > 0) {
        const index = parseInt(position) - 1;
        if (index < existingInputs.length) {
            wrapper.insertBefore(input, existingInputs[index]);
        } else {
            wrapper.appendChild(input);
        }
    } else {
        wrapper.appendChild(input);
    }

    positionInput.value = "";
});

// Delete image functionality
document.addEventListener("click", async function(e) {
    if (e.target.classList.contains("delete-image-btn") || e.target.closest(".delete-image-btn")) {
        e.preventDefault();
        e.stopPropagation();

        const button = e.target.classList.contains("delete-image-btn") ? e.target : e.target.closest(".delete-image-btn");
        
        const imageId = button.getAttribute("data-image");
        const productId = button.getAttribute("data-product-id");
        const imageType = button.getAttribute("data-image-type");
        
        if (!imageId || !productId) {
            console.error("Missing imageId or productId");
            alert("Error: Missing image or product ID");
            return;
        }

        // Find the image container
        const imageContainer = button.closest(".image-container");
        
        if (!imageContainer) {
            console.error("Could not find image container");
            return;
        }

        const confirmMsg = imageType === "vr" 
            ? "Are you sure you want to delete the VR image?"
            : "Are you sure you want to delete this image?";

        if (confirm(confirmMsg)) {
            try {
                // Show loading state
                button.disabled = true;
                button.innerHTML = "⏳";
                imageContainer.classList.add("removing");

                const endpoint = imageType === "vr"
                    ? "/admin/product/delete-vrImage"
                    : "/admin/product/delete-image";

                console.log(`Deleting ${imageType} image:`, {
                    imageId,
                    productId,
                    endpoint
                });

                const response = await axios.post(endpoint, {
                    imageId: imageId,
                    productId: productId,
                    _csrf: csrfToken
                }, {
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    timeout: 10000 // 10 second timeout
                });

                console.log("Server response:", response.data);

                if (response.status === 200 && response.data.success) {
                    // Successfully deleted - remove from DOM
                    setTimeout(() => {
                        imageContainer.remove();
                        console.log(`${imageType} image removed from DOM`);
                    }, 300);
                    
                    // Show success message
                    const successMsg = imageType === "vr" ? "VR image deleted successfully!" : "Image deleted successfully!";
                    alert(successMsg);
                    
                } else {
                    // Server returned error
                    console.error("Server error:", response.data);
                    alert(response.data.message || "Failed to delete image. Please try again.");
                    
                    // Reset button state
                    button.disabled = false;
                    button.innerHTML = "🗑️";
                    imageContainer.classList.remove("removing");
                }
            } catch (error) {
                console.error("Delete error:", error);
                
                // Reset button state
                button.disabled = false;
                button.innerHTML = "🗑️";
                imageContainer.classList.remove("removing");
                
                if (error.response) {
                    console.error("Server response:", error.response.data);
                    alert(`Error: ${error.response.data.message || 'Failed to delete image'}`);
                } else if (error.request) {
                    console.error("Network error:", error.request);
                    alert("Network error. Please check your connection and try again.");
                } else {
                    console.error("Error:", error.message);
                    alert("An unexpected error occurred. Please try again.");
                }
            }
        }
    }
});

// Form validation before submit
document.querySelector('form').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    const productPrice = document.getElementById('productPrice').value;
    const salePrice = document.getElementById('salePrice').value;
    
    if (!title) {
        alert('Please enter a product title');
        e.preventDefault();
        return;
    }
    
    if (!productPrice || productPrice <= 0) {
        alert('Please enter a valid product price');
        e.preventDefault();
        return;
    }
    
    if (!salePrice || salePrice <= 0) {
        alert('Please enter a valid sale price');
        e.preventDefault();
        return;
    }
});
</script>

<%- include('../partials/footer') %>