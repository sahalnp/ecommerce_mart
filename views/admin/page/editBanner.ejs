<%- include('../partials/header') %>
<head></head>
<%- include('../partials/navbar') %>

<!-- Include Axios -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<div class="app-content content" style="padding-top: 50px;">
  <div class="content-wrapper">
    <div class="content-body">
      <form action="/admin/banners/edit/<%= banners._id %>" method="POST" enctype="multipart/form-data">

        <!-- Title -->
        <div class="form-group">
          <label for="title">Title</label>
          <input type="text" id="title" name="title" class="form-control" value="<%= banners.title %>" required />
        </div>

        <!-- Description -->
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" class="form-control" rows="3" required><%= banners.description %></textarea>
        </div>
        <!-- Product -->
     <div class="form-group">
  <label for="productId">Linked Product</label>
  <select id="productId" name="productId" class="form-control">
    <option value="">-- None --</option>
    <% products.forEach(product => { %>
      <option 
        value="<%= product._id %>" 
        <%= banners.productId && banners.productId.toString() === product._id.toString() ? 'selected' : '' %>>
        <%= product.title %>
      </option>
    <% }) %>
  </select>
</div>

        <!-- Status -->
        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" name="status" class="form-control">
            <option value="active" <%= banners.status === 'active' ? 'selected' : '' %>>Active</option>
            <option value="inactive" <%= banners.status === 'inactive' ? 'selected' : '' %>>Inactive</option>
          </select>
        </div>

        <!-- Current Image -->
        <div class="form-group" id="image-group">
          <label for="image">Current Banner Image</label><br>
          <% if (banners.image && banners.image.filepath) { %>
            <div id="image-preview" class="d-flex align-items-center mb-2">
              <img  src="<%= banners.image.filepath %>" alt="Current Banner" width="150" class="img-thumbnail mr-2" />
              <button type="button" class="btn btn-sm btn-danger" onclick="imageDlt('<%= banners._id %>')">
                <i class="la la-trash"></i>
              </button>
            </div>
          <% } else { %>
            <p id="no-image">No image available.</p>
          <% } %>
          <input type="file" id="image" name="image" accept="image/*" class="form-control" />
        </div>

        <button type="submit" class="btn btn-primary">Update Banner</button>
      </form>
    </div>
  </div>
</div>

<script>
  const csrfToken = "<%= csrfToken %>";

  async function imageDlt(id) {
    if (!confirm("Are you sure you want to delete the image?")) return;

    try {
      const res = await axios.post('/admin/banner/image/delete', {
        id,
        _csrf: csrfToken
      });

      if (res.data.success) {
        const preview = document.getElementById('image-preview');
        if (preview) preview.remove();

        const noImage = document.createElement('p');
        noImage.id = 'no-image';
        noImage.innerText = 'No image available.';
        document.getElementById('image-group').prepend(noImage);
      }
    } catch (err) {
      alert('Failed to delete image');
      console.error(err);
    }
  }
</script>

<%- include('../partials/footer') %>
