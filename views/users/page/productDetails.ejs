<%- include('../partials/header') %>
<head>
    <link rel="stylesheet" href="/assets/css/prodDetail.css" />
    <link
        href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/8.4.7/swiper-bundle.min.css"
        rel="stylesheet"
    />
</head>

<main class="product-detail-page">
    <div class="container my-5">
        <div class="row gx-4 align-items-start">
            <!-- Image Slider -->
            <div class="col-md-6">
                <div class="swiper mainSwiper">
                    <div class="swiper-wrapper">
                        <% for(let i = 0; i < product.image.length; i++) { %>
                        <div class="swiper-slide">
                            <div class="zoom-wrapper">
                                <img
                                    id="zoomImage"
                                    src="<%= product.image[i].filepath %>"
                                    class="zoom-inner"
                                />
                            </div>
                        </div>
                        <% } %>
                    </div>
                </div>

                <div class="thumbnail-container d-flex flex-wrap gap-2 mt-3">
                    <% product.image.forEach(function(image, index) { %>
                    <div
                        class="thumbnail-wrapper"
                        style="width: calc(25% - 8px)"
                    >
                        <img
                            src="<%= image.filepath %>"
                            class="thumbnail <%= index === 0 ? 'active' : '' %>"
                            data-index="<%= index %>"
                            alt="Thumbnail <%= index + 1 %>"
                            style="height: 80px"
                        />
                    </div>
                    <% }) %>
                </div>
            </div>

            <!-- Product Info -->
            <div class="col-lg-6 product-info">
                <h1 class="product-title mb-3"><%= product.title %></h1>
                <div class="d-flex">
                    <div class="star-rating small" id="rating-stars">
                        <% for (let i = 1; i <= 5; i++) { const full =
                        Math.floor(avg); const isHalf = avg % 1 >= 0.25 && avg %
                        1 < 0.75; const halfStarPosition = full + 1; %> <% if (i
                        <= full) { %>
                        <span class="full" data-value="<%= i %>">&#9733;</span>
                        <% } else if (i === halfStarPosition && isHalf) { %>
                        <span class="half" data-value="<%= i %>">&#9733;</span>
                        <% } else { %>
                        <span data-value="<%= i %>">&#9733;</span>
                        <% } %> <% } %>
                    </div>

                    <span class="text-muted medium mt-1"
                        >&nbsp;(<%= totalUser %> ratings)</span
                    >
                </div>

                <div class="price-section">
                    <span class="current-price"
                        >â‚¹<%= product.pricing.salePrice %></span
                    >
                    <span class="original-price"
                        ><del>â‚¹<%= product.pricing.price %></del></span
                    >
                    <span class="savings-badge">Save <%= discount %>%</span>
                </div>
                <% if (product.inStock <= 2 && product.inStock > 0) { %>
                <div class="stock-less">
                    Only a few items left in stock. Hurry!
                </div>
                <% } else if (product.inStock > 2) { %>
                <div class="stock-status">In Stock</div>
                <% } else { %>
                <div class="text-danger">Out of stock</div>
                <% } %>

                <div class="product-highlights">
                    <ul class="list-unstyled custom-list">
                        <% if (product.deliveryDate) { %>
                        <li>âœ“ Free delivery by <%= product.deliveryDate %></li>
                        <% } else { %>
                        <li>âœ“ Free delivery within 3â€“5 days</li>
                        <% } %> <% if (product.warranty) { %>
                        <li>âœ“ <%= product.warranty %> warranty</li>
                        <% } else { %>
                        <li>âœ“ Warranty included</li>
                        <% } %>

                        <li>âœ“ 7-day returns policy</li>
                        <li>âœ“ Virtual Try-On Available</li>
                    </ul>
                </div>

                <form action="/product/<%= product._id %>" method="POST">
                    <input
                        type="hidden"
                        name="_csrf"
                        value="<%= csrfToken %>"
                    />
                    <input
                        type="hidden"
                        name="productId"
                        value="<%= product._id %>"
                    />
                    <input
                        type="hidden"
                        id="quantityInput"
                        name="quantity"
                        value="<%= cartItems ? cartItems.quantity : 1 %>"
                    />

                    <div
                   <div class="quantity-control d-flex align-items-center gap-2">
  <label for="quantity" class="mb-0 mr-2 font-weight-medium">Quantity:</label>

  <button
    class="btn-qty btn-decrease text-dark"
    type="button"
    onclick="updateQty('<%= product._id %>', -1)">
    âˆ’
  </button>

  <span
    id="quantity"
    class="qty-value"
    style="min-width: 30px; text-align: center">
    <%= cartItems ? cartItems.quantity : 1 %>
  </span>

  <!-- Hidden input for actual quantity value -->
  <input type="hidden" id="quantityInput" value="<%= cartItems ? cartItems.quantity : 1 %>">

  <button
    class="btn-qty btn-increase text-dark"
    type="button"
    onclick="updateQty('<%= product._id %>', 1)">
    +
  </button>
</div>

                    <div class="action-buttons">
                        <!-- Primary action buttons in a row -->
                        <div class="primary-actions">
                            <% if (exist === true) { %>
                            <a href="/cart" class="btn btn-add-to-cart">
                                <i class="fas fa-shopping-cart me-2"></i>&nbsp
                                Go to Cart
                            </a>
                            <% } else if (product.inStock <= 0 || (cartItems &&
                            cartItems.quantity <= 0)) { %>
                            <button
                                type="submit"
                                class="btn btn-add-to-cart"
                                disabled
                                style="opacity: 0.5; cursor: not-allowed"
                            >
                                <i class="fas fa-shopping-cart me-2"></i>&nbsp
                                Add to Cart
                            </button>
                            <% } else { %>
                            <button
                                type="submit"
                                class="btn btn-add-to-cart"
                                onclick="addToCart()"
                            >
                                <i class="fas fa-shopping-cart me-2"></i>&nbsp
                                Add to Cart
                            </button>
                            <% } %> <% if (product.inStock <= 0) { %>
                            <button
                                type="button"
                                class="btn btn-buy-now"
                                disabled
                            >
                                <i class="fas fa-bolt me-2"></i>&nbsp Buy Now
                            </button>
                            <% } else { %>
                            <button
                                type="button"
                                class="btn btn-buy-now"
                                onclick="buy('<%= product._id %>')"
                            >
                                <i class="fas fa-bolt me-2"></i>&nbsp Buy Now
                            </button>
                            <% } %>
                            <a
                                href="/tryOn/<%=product._id %>"
                                type="button"
                                class="btn btn-try-on pulse-animation"
                                id="try-on-btn"
                            >
                                <i class="fas fa-vr-cardboard me-2"></i>&nbsp
                                Try On
                            </a>
                            <button
                                type="button"
                                class="show"
                                onclick="window.location.href='/order/review/<%= product._id %>'"
                            >
                                <i class="fas fa-star me-2"></i> Show Review
                            </button>
                        </div>

                        <!-- Secondary action button -->
                        <div class="secondary-actions">
                            <% if (cmp) { %>
                            <a
                                href="/compare"
                                type="button"
                                class="btn btn-outline-secondary"
                            >
                                <i class="fas fa-exchange-alt me-2"></i> &nbsp
                                Go to compare page
                            </a>
                            <% } else { %>
                            <button
                                type="button"
                                class="btn btn-outline-secondary"
                                onclick="addForComparison()"
                            >
                                <i class="fas fa-exchange-alt me-2"></i> &nbsp
                                Add for comparison
                            </button>
                            <% } %>
                        </div>

                        <div class="cart-toast">Item added to cart! ðŸŽ‰</div>
                    </div>
                </form>

                <div class="product-specs">
                    <h5 class="mb-3">Product Specifications</h5>
                    <div class="specs-grid">
                        <div class="spec-item">
                            <span class="spec-label">Brand:</span>&nbsp <%=
                            product.brand.name %>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Band Material:</span>&nbsp
                            <%= product.bandMaterial %>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Case Diameter:</span
                            >&nbsp<%= product.caseDiameter %>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Band Color:</span>&nbsp <%=
                            product.bandColour %>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">About this item</h4>
                        <div class="card-text">
                            <%= product.description %>
                            <ul class="mt-3">
                                <li>
                                    Premium <%= product.bandMaterial %> band
                                    material
                                </li>
                                <li>
                                    <%= product.waterResistance %> water
                                    resistance
                                </li>
                                <li>
                                    <%= product.warranty %> manufacturer
                                    warranty
                                </li>
                                <li>
                                    Virtual Try-On feature to see how it looks
                                    on your wrist
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="quantity-toast" class="quantity-toast"></div>
    <div
        id="compare-toast"
        style="
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            max-width: 250px;
            text-align: center;
            pointer-events: none;
        "
    ></div>
</main>


// <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/8.4.7/swiper-bundle.min.js"></script>

<script>
  const csrfToken = "<%= csrfToken %>";
  const productId = "<%= product._id %>";
  const length = <%= product.image.length %>;
  const productImage = "<%= product.image[0].filepath %>";
  const stock = <%= product.inStock %>;

  document.addEventListener("DOMContentLoaded", function () {
    // Initialize Swiper
    const swiper = new Swiper('.mainSwiper', {
      spaceBetween: 10,
      loop: false,
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
    });

    const thumbnails = document.querySelectorAll('.thumbnail');
    thumbnails.forEach((thumb, index) => {
      thumb.addEventListener('click', function () {
        thumbnails.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        swiper.slideTo(index);
      });
    });

    swiper.on('slideChange', function () {
      const activeIndex = swiper.activeIndex;
      thumbnails.forEach((thumb, index) => {
        thumb.classList.toggle('active', index === activeIndex);
      });
    });

    const tryOnModal = document.getElementById('try-on-modal');
    const tryOnBtn = document.getElementById('try-on-btn');
    const closeModal = document.getElementById('close-modal');
    const watchOverlay = document.getElementById('watch-overlay');

    if (tryOnBtn) {
      tryOnBtn.addEventListener('click', function () {
        if (tryOnModal) {
          tryOnModal.style.display = 'block';
          document.body.style.overflow = 'hidden';
        }
      });
    }

    if (closeModal) {
      closeModal.addEventListener('click', function () {
        tryOnModal.style.display = 'none';
        document.body.style.overflow = 'auto';
      });
    }

    window.addEventListener('click', function (event) {
      if (event.target === tryOnModal) {
        tryOnModal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    });

    const decreaseBtn = document.querySelector(".btn-decrease");
    const increaseBtn = document.querySelector(".btn-increase");
    const quantitySpan = document.getElementById("quantity");
    const quantityInput = document.getElementById("quantityInput");
    const toast = document.getElementById("quantity-toast");

    let quantity = parseInt(quantityInput.value);
    const min = 1;
    const max = 10;

    function showToast(message) {
      toast.textContent = message;
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }

    function updateQuantity(newQty) {
      quantity = newQty;
      quantitySpan.textContent = quantity;
      quantityInput.value = quantity;
      quantityChnge(productId, quantity);
    }

    decreaseBtn.addEventListener("click", (e) => {
      e.preventDefault();
      if (quantity > min) {
        updateQuantity(quantity - 1);
      }
    });

    increaseBtn.addEventListener("click", (e) => {
      e.preventDefault();
      if (quantity >= stock) {
        showToast(`Only ${stock} item(s) available in stock`);
        return;
      }
      if (quantity >= max) {
        showToast("Maximum quantity allowed is 10");
        return;
      }
      updateQuantity(quantity + 1);
    });

    if (watchOverlay) {
      let isDragging = false;
      let currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;

      watchOverlay.addEventListener("mousedown", dragStart);
      watchOverlay.addEventListener("mouseup", dragEnd);
      watchOverlay.addEventListener("mousemove", drag);

      function dragStart(e) {
        initialX = e.clientX - xOffset;
        initialY = e.clientY - yOffset;
        if (e.target === watchOverlay) isDragging = true;
      }

      function dragEnd(e) {
        initialX = currentX;
        initialY = currentY;
        isDragging = false;
      }

      function drag(e) {
        if (isDragging) {
          e.preventDefault();
          currentX = e.clientX - initialX;
          currentY = e.clientY - initialY;
          xOffset = currentX;
          yOffset = currentY;
          setTranslate(currentX, currentY, watchOverlay);
        }
      }

      function setTranslate(x, y, el) {
        el.style.transform = `translate3d(${x}px, ${y}px, 0)`;
      }
    }
  });

  const zoomWrappers = document.querySelectorAll(".zoom-wrapper");
  zoomWrappers.forEach(wrapper => {
    const img = wrapper.querySelector(".zoom-inner");

    wrapper.addEventListener("mousemove", function (e) {
      const rect = wrapper.getBoundingClientRect();
      const xPercent = ((e.clientX - rect.left) / rect.width) * 100;
      const yPercent = ((e.clientY - rect.top) / rect.height) * 100;
      img.style.transformOrigin = `${xPercent}% ${yPercent}%`;
      img.style.transform = "scale(2)";
    });

    wrapper.addEventListener("mouseleave", function () {
      img.style.transform = "scale(1)";
    });
  });

  async function quantityChnge(productId, quantity) {
    try {
      await axios.post('/cart/quantity', {
        productId,
        quantity,
        _csrf: csrfToken
      });
      console.log("Quantity updated to:", quantity);
    } catch (error) {
      console.error("Failed to update quantity", error);
      alert("Failed to update quantity");
    }
  }

  async function addToCart(productId) {
    try {
      const res = await axios.post('/add-to-cart', {
        productId,
        _csrf: csrfToken
      }, { withCredentials: true });

      const toast = document.querySelector('.cart-toast');
      if (toast) {
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 3000);
      }
    } catch (error) {
      console.error("Failed to add to cart", error);
    }
  }

  async function addForComparison() {
    try {
      const res = await axios.post('/addCompare', {
        productId,
        _csrf: csrfToken
      }, { withCredentials: true });

      const toast = document.getElementById('compare-toast');
      toast.textContent = 'Product added for comparison âœ…';
      toast.style.display = 'block';
      toast.style.animation = 'none';
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease-out, fadeOut 0.5s 2.0s ease-in forwards';
      }, 10);
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    } catch (error) {
      console.error("Compare error", error);
    }
  }

  async function buy(productId) {
    const quantityInput = document.getElementById("quantityInput");
    const quantity = quantityInput ? parseInt(quantityInput.value) : 1;

    try {
      await axios.post("/buy", { productId, quantity, _csrf: csrfToken });
      window.location.href = "/checkout";
    } catch (error) {
      console.error("Buy error:", error);
      alert("Failed to place order");
    }
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<%- include('../partials/footer') %>
