<%- include('../partials/header') %>
<head>
  <link rel="stylesheet" href="/assets/css/index.css">
</head>

<main>
    <!-- Single Slider -->
    <div class="single-slider slider-height d-flex align-items-center slide-bg">
        <div class="container">
            <div class="row justify-content-between align-items-center">
                <div class="col-xl-8 col-lg-8 col-md-8 col-sm-8">
                    <div class="hero__caption">
                        <h1 data-animation="fadeInLeft" data-delay=".4s" data-duration="2000ms">Select Your New Perfect Style</h1>
                        <p data-animation="fadeInLeft" data-delay=".7s" data-duration="2000ms">
                           Discover timepieces that don‚Äôt just tell time ‚Äî they tell your story. Elegance, precision, and personality in every tick.
                        </p>
                        <div class="hero__btn" data-animation="fadeInLeft" data-delay=".8s" data-duration="2000ms">
                            <a href="/shop" class="btn hero-btn " style="padding: 20px;">Shop Now</a>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-3 col-md-4 col-sm-4 d-none d-sm-block">
                    <div class="hero__img" data-animation="bounceIn" data-delay=".4s">
                        <img src="assets/img/hero/watch.png" alt="" class="heartbeat">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- slider Area End-->

    <!-- New Product Start -->
    <section class="new-product-area section-padding30">
        <div class="container">
            <div class="row">
                <div class="col-xl-12">
                    <div class="section-tittle mb-70">
                        <h2>New Arrivals</h2>
                    </div>
                </div>
            </div>

            <div class="row">
                <% prod.slice(0, 3).forEach(p => { %>
                <div class="col-xl-4 col-lg-4 col-md-6 col-sm-6">
                    <div class="single-new-pro text-center">
                        <div class="product-img position-relative">
                            <a href="/product/<%= p._id %>">
                                <img src="<%= p.image[0].filepath %>" alt="<%= p.title %>" class="fixed-img">
                            </a>

                            <!-- Add to Cart Button -->
                            <div class="addtoCart">
 <% if (cart.includes(String(p._id))) { %>
    <button onclick="goToCart()" class="add-cart-btn">
        <i class="fas fa-shopping-cart"></i> Go to Cart
    </button>
<% } else if (p.inStock <= 0) { %>
    <button class="add-cart-btn" disabled style="opacity: 0.5; cursor: not-allowed;">
        <i class="fas fa-shopping-cart"></i> Out of Stock
    </button>
<% } else { %>
    <button onclick="addToCart('<%= p._id %>')" class="add-cart-btn">
        <i class="fas fa-shopping-cart"></i> Add to Cart
    </button>
<% } %>


                            </div>

                            <!-- Wishlist Icon -->
                            <div class="favorit-items">
                                <i class="heart-icon <%= wish.some(w => w._id.toString() === p._id.toString()) ? 'fas liked' : 'far' %> fa-heart"
                                    onclick="toggleWishlist('<%= p._id %>', '<%= wish.some(w => w._id.toString() === p._id.toString()) ? 'true' : 'false' %>')"></i>
                            </div>
                        </div>

                        <div class="product-caption">
                            <h3><a href="/product/<%= p._id %>"><%= p.title %></a></h3>
                            <span>&#8377;<%= p.pricing.salePrice %></span>
                        </div>
                    </div>
                </div>
                <% }); %>
            </div>
        </div>
    </section>

            <div class="row justify-content-center">
                <div class="room-btn pt-70">
                    <a href="/shop" class="btn view-btn1">View More Products</a>
                </div>
            </div>
        </div>
    </div>
    <div class="shop-method-area pt-5">
        <div class="container">
            <div class="method-wrapper">
                <div class="row d-flex justify-content-between">
                    <div class="col-xl-4 col-lg-4 col-md-6">
                        <div class="single-method mb-40">
                            <i class="ti-package"></i>
                            <h6>Free Shipping Method</h6>
                            <p>Fast and reliable delivery to your doorstep with no additional charges on orders above ‚Çπ999.</p>
                        </div>
                    </div>
                    <div class="col-xl-4 col-lg-4 col-md-6">
                        <div class="single-method mb-40">
                            <i class="ti-unlock"></i>
                            <h6>Secure Payment System</h6>
                            <p>Your transactions are protected with industry-standard encryption and secure payment gateways.</p>
                        </div>
                    </div>
                    <div class="col-xl-4 col-lg-4 col-md-6">
                        <div class="single-method mb-40">
                            <i class="ti-reload"></i>
                            <h6>Easy Return Policy</h6>
                            <p>Hassle-free returns within 30 days if you're not completely satisfied with your purchase.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="cart-toast">Item added to cart! üéâ</div>
    <div class="wishlist-toast">Item removed from wishlist! ‚ùå</div>
    <div class="stock-toast">Item is out of stock! üì¶</div>
</main>

<script>
const csrfToken = "<%= csrfToken %>";

function showToast(selector, message, color = "#dc3545") {
    const toast = document.querySelector(selector);
    if (toast) {
        toast.textContent = message;
        toast.style.background = color;
        toast.style.display = "block";
        setTimeout(() => {
            toast.style.display = "none";
        }, 2000);
    }
}

async function addToCart(productId) {
    try {
        const res = await axios.post(
            "/product/add-to-cart",
            {
                productId,
                quantity: 1,
                _csrf: csrfToken,
            },
            {
                withCredentials: true,
                headers: {
                    "CSRF-Token": csrfToken,
                },
            }
        );

        // Success: Show toast and reload
        showToast(".cart-toast", "Item added to cart! üéâ", "#28a745");
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    } catch (err) {
        console.error("Add to cart error:", err);
        alert("Failed to add item to cart.");
    }
}

async function toggleWishlist(productId, liked) {
    try {
        if (liked === "true") {
            await axios.post(`/wishlist/remove/${productId}`, { _csrf: csrfToken }, {
                withCredentials: true,
                headers: { "CSRF-Token": csrfToken }
            });

            showToast(".wishlist-toast", "Item removed from wishlist! ‚ùå");
        } else {
            await axios.post(`/wishlist/add/${productId}`, { _csrf: csrfToken }, {
                withCredentials: true,
                headers: { "CSRF-Token": csrfToken }
            });

            showToast(".wishlist-toast", "Item added to wishlist! ‚ù§Ô∏è", "#28a745");
        }

        const icon = document.querySelector(`.heart-icon[onclick*="${productId}"]`);
        if (icon) {
            if (liked === "true") {
                icon.classList.remove("fas", "liked");
                icon.classList.add("far");
                icon.setAttribute("onclick", `toggleWishlist('${productId}', 'false')`);
            } else {
                icon.classList.remove("far");
                icon.classList.add("fas", "liked");
                icon.setAttribute("onclick", `toggleWishlist('${productId}', 'true')`);
            }
        }
    } catch (err) {
        console.error("Wishlist toggle error:", err);
        alert("Failed to update wishlist.");
    }
}

function goToCart() {
    window.location.href = "/cart";
}

function showOutOfStockToast() {
    showToast(".stock-toast", "Item is out of stock! üì¶");
}
</script>

<%- include('../partials/footer') %>