<%- include('../partials/header') %>
<head>
  <link rel="stylesheet" href="/assets/css/index.css">
</head>

<main>
    <!-- Single Slider -->
    <div class="single-slider slider-height d-flex align-items-center slide-bg">
        <div class="container">
            <div class="row justify-content-between align-items-center">
                <div class="col-xl-8 col-lg-8 col-md-8 col-sm-8">
                    <div class="hero__caption">
                        <h1 data-animation="fadeInLeft" data-delay=".4s" data-duration="2000ms">Select Your New Perfect Style</h1>
                        <p data-animation="fadeInLeft" data-delay=".7s" data-duration="2000ms">
                           Discover timepieces that don‚Äôt just tell time ‚Äî they tell your story. Elegance, precision, and personality in every tick.
                        </p>
                        <div class="hero__btn" data-animation="fadeInLeft" data-delay=".8s" data-duration="2000ms">
                            <a href="/shop" class="btn hero-btn " style="padding: 20px;">Shop Now</a>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-3 col-md-4 col-sm-4 d-none d-sm-block">
                    <div class="hero__img" data-animation="bounceIn" data-delay=".4s">
                        <img src="assets/img/hero/watch.png" alt="" class="heartbeat">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- slider Area End-->

    <!-- New Product Start -->
    <section class="new-product-area section-padding30">
        <div class="container">
            <div class="row">
                <div class="col-xl-12">
                    <div class="section-tittle mb-70">
                        <h2>New Arrivals</h2>
                    </div>
                </div>
            </div>

            <div class="row">
                <% prod.slice(0, 3).forEach(p => { %>
                <div class="col-xl-4 col-lg-4 col-md-6 col-sm-6">
                    <div class="single-new-pro text-center">
                        <div class="product-img position-relative">
                            <a href="/product/<%= p._id %>">
                                <img src="<%= p.image[0].filepath %>" alt="<%= p.title %>" class="fixed-img">
                            </a>

                            <!-- Add to Cart Button -->
                            <div class="addtoCart">
                                <% if (cart.includes(String(p._id))) { %>
                                    <button onclick="goToCart()" class="add-cart-btn">
                                        <i class="fas fa-shopping-cart"></i> Go to Cart
                                    </button>
                                <% } else { %>
                                   <% if (p.inStock <= 0) { %>                                      
                                            <button onclick="showOutOfStockToast()" class="add-cart-btn" disabled>                                         
                                                <i class="fas fa-shopping-cart"></i> Add to Cart                                     
                                            </button>                                     
                                        <% } else { %>                                        
                                            <button onclick="addToCart('<%= p._id %>')" class="add-cart-btn">                                         
                                                <i class="fas fa-shopping-cart"></i> Add to Cart                                     
                                            </button>                                     
                                        <% } %>
                                <% } %>
                            </div>

                            <!-- Wishlist Icon -->
                            <div class="favorit-items">
                                <i class="heart-icon <%= wish.some(w => w._id.toString() === p._id.toString()) ? 'fas liked' : 'far' %> fa-heart"
                                    onclick="toggleWishlist('<%= p._id %>', '<%= wish.some(w => w._id.toString() === p._id.toString()) ? 'true' : 'false' %>')"></i>
                            </div>
                        </div>

                        <div class="product-caption">
                            <h3><a href="/product/<%= p._id %>"><%= p.title %></a></h3>
                            <span>&#8377;<%= p.pricing.salePrice %></span>
                        </div>
                    </div>
                </div>
                <% }); %>
            </div>
        </div>
    </section>
    <!-- New Product End -->

    <!-- Popular Items Start -->
    <div class="popular-items">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-xl-7 col-lg-8 col-md-10">
                    <div class="section-tittle mb-70 text-center">
                        <h2>Popular Items</h2>
                        <p>Consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Quis ipsum suspendisse ultrices gravida.</p>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center">
                <div class="room-btn pt-70">
                    <a href="/shop" class="btn view-btn1">View More Products</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Popular Items End -->

    <!-- Watch Highlights -->
    <div class="watch-area section-padding30">
        <div class="container">
            <div class="row align-items-center justify-content-between padding-130">
                <div class="col-lg-5 col-md-6">
                    <div class="watch-details mb-40">
                        <h2>Watch of Choice</h2>
                        <p>Enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse.</p>
                        <a href="/shop" class="btn">Show Watches</a>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-10">
                    <div class="choice-watch-img mb-40">
                        <img src="assets/img/gallery/choce_watch1.png" alt="">
                    </div>
                </div>
            </div>
            <div class="row align-items-center justify-content-between">
                <div class="col-lg-6 col-md-6 col-sm-10">
                    <div class="choice-watch-img mb-40">
                        <img src="assets/img/gallery/choce_watch2.png" alt="">
                    </div>
                </div>
                <div class="col-lg-5 col-md-6">
                    <div class="watch-details mb-40">
                        <h2>Watch of Choice</h2>
                        <p>Enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse.</p>
                        <a href="/shop" class="btn">Show Watches</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shopping Methods -->
    <div class="shop-method-area">
        <div class="container">
            <div class="method-wrapper">
                <div class="row d-flex justify-content-between">
                    <div class="col-xl-4 col-lg-4 col-md-6">
                        <div class="single-method mb-40">
                            <i class="ti-package"></i>
                            <h6>Free Shipping Method</h6>
                            <p>Fast and reliable delivery to your doorstep with no additional charges on orders above ‚Çπ999.</p>
                        </div>
                    </div>
                    <div class="col-xl-4 col-lg-4 col-md-6">
                        <div class="single-method mb-40">
                            <i class="ti-unlock"></i>
                            <h6>Secure Payment System</h6>
                            <p>Your transactions are protected with industry-standard encryption and secure payment gateways.</p>
                        </div>
                    </div>
                    <div class="col-xl-4 col-lg-4 col-md-6">
                        <div class="single-method mb-40">
                            <i class="ti-reload"></i>
                            <h6>Easy Return Policy</h6>
                            <p>Hassle-free returns within 30 days if you're not completely satisfied with your purchase.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="cart-toast">Item added to cart! üéâ</div>
    <div class="wishlist-toast">Item removed from wishlist! ‚ùå</div>
    <div class="stock-toast">Item is out of stock! üì¶</div>
</main>

<script>
    const csrfToken = "<%= csrfToken %>";

    async function addToCart(productId) {
        try {
            const res = await axios.post(`/product/add-to-cart`, {
                productId,
                quantity: 1,
                _csrf: csrfToken,
            }, {
                withCredentials: true,
                headers: { 'CSRF-Token': csrfToken },
            });

            const toast = document.querySelector('.cart-toast');
            if (toast) {
                toast.style.display = 'block';
                setTimeout(() => {
                    toast.style.display = 'none';
                    window.location.reload();
                }, 2000);
            } else {
                console.warn("Cart toast not found");
            }
        } catch (err) {
            console.error("Add to cart error:", err);
            alert("Add to cart failed");
        }
    }
    
    async function toggleWishlist(productId, liked) {
        try {
            if (liked === 'true') {
                await axios.post(`/wishlist/remove/${productId}`, { 
                    _csrf: csrfToken 
                }, { 
                    withCredentials: true,
                    headers: { 'CSRF-Token': csrfToken }
                });
                
                const toast = document.querySelector('.wishlist-toast');
                if (toast) {
                    toast.textContent = 'Item removed from wishlist! ‚ùå';
                    toast.style.display = 'block';
                    setTimeout(() => {
                        toast.style.display = 'none';
                    }, 2000);
                }
            } else {
                await axios.post(`/wishlist/add/${productId}`, { 
                    _csrf: csrfToken 
                }, { 
                    withCredentials: true,
                    headers: { 'CSRF-Token': csrfToken }
                });
                
                const toast = document.querySelector('.wishlist-toast');
                if (toast) {
                    toast.textContent = 'Item added to wishlist! ‚ù§Ô∏è';
                    toast.style.background = '#28a745';
                    toast.style.display = 'block';
                    setTimeout(() => {
                        toast.style.display = 'none';
                        toast.style.background = '#dc3545';
                    }, 2000);
                }
            }

            const icon = document.querySelector(`.heart-icon[onclick*="${productId}"]`);
            if (icon) {
                if (liked === 'true') {
                    icon.classList.remove("fas", "liked");
                    icon.classList.add("far");
                    icon.setAttribute("onclick", `toggleWishlist('${productId}', 'false')`);
                } else {
                    icon.classList.remove("far");
                    icon.classList.add("fas", "liked");
                    icon.setAttribute("onclick", `toggleWishlist('${productId}', 'true')`);
                }
            }
        } catch (err) {
            console.error("Wishlist toggle error:", err);
            alert("Failed to update wishlist.");
        }
    }

    function goToCart() {
        window.location.href = "/cart";
    }
    function showOutOfStockToast() {
  const toast = document.querySelector('.stock-toast');
  if (toast) {
    toast.style.display = 'block';
    setTimeout(() => {
      toast.style.display = 'none';
    }, 3000);
  }
}
</script>

<%- include('../partials/footer') %>